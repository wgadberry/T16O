<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funder Trace - Downstream Funding Discovery</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-green: #4ecca3;
            --accent-blue: #58a6ff;
            --accent-orange: #f0883e;
            --accent-red: #f85149;
            --accent-purple: #a371f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent-green);
        }

        .header .subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-left: 12px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .input-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .input-section h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .input-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-group {
            flex: 1;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-group input {
            width: 100%;
            padding: 12px 14px;
            font-size: 14px;
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s;
        }

        .input-group input:focus {
            border-color: var(--accent-green);
        }

        .input-group input::placeholder {
            color: var(--text-secondary);
        }

        .options-row {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-green);
        }

        .checkbox-group label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .btn {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-green);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: #5fd9b0;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .status-bar {
            display: none;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px 16px;
            margin-top: 16px;
            font-size: 13px;
        }

        .status-bar.visible {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-bar.loading {
            border-color: var(--accent-blue);
        }

        .status-bar.success {
            border-color: var(--accent-green);
        }

        .status-bar.error {
            border-color: var(--accent-red);
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .results-header h2 {
            font-size: 16px;
            font-weight: 600;
        }

        .results-stats {
            display: flex;
            gap: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-green);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .results-table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .results-table td {
            padding: 12px 16px;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .results-table tr:last-child td {
            border-bottom: none;
        }

        .results-table tr:hover {
            background: var(--bg-tertiary);
        }

        .address-cell {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .address-cell a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .address-cell a:hover {
            text-decoration: underline;
        }

        .amount-cell {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-green);
        }

        .source-badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            border-radius: 4px;
        }

        .source-badge.db {
            background: rgba(163, 113, 247, 0.2);
            color: var(--accent-purple);
        }

        .source-badge.api {
            background: rgba(240, 136, 62, 0.2);
            color: var(--accent-orange);
        }

        .confirmed-badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            border-radius: 4px;
            background: rgba(78, 204, 163, 0.2);
            color: var(--accent-green);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .copy-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            margin-left: 6px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .copy-btn:hover {
            opacity: 1;
            color: var(--accent-green);
        }

        .tx-link {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .tx-link a {
            color: var(--text-secondary);
            text-decoration: none;
        }

        .tx-link a:hover {
            color: var(--accent-blue);
        }

        .depth-notice {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid rgba(88, 166, 255, 0.3);
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 16px;
            font-size: 13px;
            color: var(--accent-blue);
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center;">
            <h1>Funder Trace</h1>
            <span class="subtitle">Downstream Funding Discovery</span>
        </div>
        <div style="font-size: 12px; color: var(--text-secondary);">
            Port 5070
        </div>
    </div>

    <div class="container">
        <div class="input-section">
            <h2>Trace Funded Addresses</h2>
            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                Enter a wallet address to discover all addresses that received their initial funding from this wallet.
            </p>

            <div class="input-row">
                <div class="input-group">
                    <label>Funder Wallet Address</label>
                    <input type="text" id="addressInput" placeholder="Enter Solana wallet address...">
                </div>
                <button class="btn btn-primary" id="traceBtn" onclick="traceAddress()">
                    Trace Funding
                </button>
            </div>

            <div class="options-row">
                <div class="checkbox-group">
                    <input type="radio" name="direction" id="dirBoth" value="both" checked>
                    <label for="dirBoth">Both directions</label>
                </div>
                <div class="checkbox-group">
                    <input type="radio" name="direction" id="dirDownstream" value="downstream">
                    <label for="dirDownstream">Downstream only</label>
                </div>
                <div class="checkbox-group">
                    <input type="radio" name="direction" id="dirUpstream" value="upstream">
                    <label for="dirUpstream">Upstream only</label>
                </div>
                <div class="checkbox-group" style="margin-left: 20px;">
                    <input type="checkbox" id="refreshCheck">
                    <label for="refreshCheck">Force refresh</label>
                </div>
            </div>

            <div class="options-row" id="depthRow" style="display: none;">
                <div class="checkbox-group">
                    <label for="depthInput" style="margin-right: 8px;">Depth levels:</label>
                    <input type="number" id="depthInput" value="10" min="1" max="50"
                           style="width: 60px; padding: 6px 10px; font-size: 13px;
                                  background: var(--bg-tertiary); border: 1px solid var(--border-color);
                                  border-radius: 4px; color: var(--text-primary);">
                </div>
            </div>

            <div class="status-bar" id="statusBar">
                <div class="spinner" id="spinner"></div>
                <span id="statusText">Processing...</span>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="depth-notice" id="depthNotice" style="display: none;">
                Multi-level tracing coming soon. Currently showing direct (level-1) funded addresses only.
            </div>

            <div class="results-header">
                <h2>Funded Addresses</h2>
                <div class="results-stats">
                    <div class="stat">
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">Total Found</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="dbCount">0</div>
                        <div class="stat-label">From Cache</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="apiCount">0</div>
                        <div class="stat-label">From API</div>
                    </div>
                </div>
            </div>

            <div class="results-table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Funded Address</th>
                            <th>Amount (SOL)</th>
                            <th>Transaction</th>
                            <th>Source</th>
                            <th>Confirmed</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                    </tbody>
                </table>
            </div>

            <div class="empty-state" id="emptyState" style="display: none;">
                <h3>No Funded Addresses Found</h3>
                <p>This wallet hasn't funded any other addresses, or the data isn't available yet.</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';  // Same origin

        // Allow Enter key to trigger search
        document.getElementById('addressInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                traceAddress();
            }
        });

        // Show/hide depth option based on direction
        document.querySelectorAll('input[name="direction"]').forEach(radio => {
            radio.addEventListener('change', function() {
                document.getElementById('depthRow').style.display =
                    (this.value === 'upstream' || this.value === 'both') ? 'flex' : 'none';
            });
        });
        // Show depth by default since "both" is selected
        document.getElementById('depthRow').style.display = 'flex';

        function showStatus(message, type = 'loading') {
            const bar = document.getElementById('statusBar');
            const text = document.getElementById('statusText');
            const spinner = document.getElementById('spinner');

            bar.className = 'status-bar visible ' + type;
            text.textContent = message;
            spinner.style.display = type === 'loading' ? 'block' : 'none';
        }

        function hideStatus() {
            document.getElementById('statusBar').className = 'status-bar';
        }

        function truncateAddress(addr) {
            if (!addr) return '';
            return addr.substring(0, 6) + '...' + addr.substring(addr.length - 4);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Brief visual feedback could be added here
            });
        }

        async function traceAddress() {
            const address = document.getElementById('addressInput').value.trim();
            const refresh = document.getElementById('refreshCheck').checked;
            const direction = document.querySelector('input[name="direction"]:checked').value;
            const depth = parseInt(document.getElementById('depthInput').value) || 10;

            if (!address) {
                showStatus('Please enter an address', 'error');
                return;
            }

            // Disable button
            const btn = document.getElementById('traceBtn');
            btn.disabled = true;
            btn.textContent = 'Tracing...';

            try {
                let upstreamItems = [];
                let downstreamItems = [];
                let upstreamCount = 0;
                let downstreamCount = 0;

                // Fetch upstream if needed
                if (direction === 'upstream' || direction === 'both') {
                    showStatus('Tracing funding chain upstream...', 'loading');
                    const upRes = await fetch(`${API_BASE}/api/trace-upstream`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, refresh, depth })
                    });
                    const upData = await upRes.json();
                    if (upData.success && upData.funding_chain) {
                        upstreamItems = upData.funding_chain.map(item => ({
                            ...item,
                            direction: 'upstream'
                        }));
                        upstreamCount = upData.total_levels || 0;
                    }
                }

                // Fetch downstream if needed
                if (direction === 'downstream' || direction === 'both') {
                    showStatus('Tracing funded addresses downstream...', 'loading');
                    const downRes = await fetch(`${API_BASE}/api/trace`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ address, refresh, depth: 1 })
                    });
                    const downData = await downRes.json();
                    if (downData.success && downData.funded_addresses) {
                        downstreamItems = downData.funded_addresses.map(item => ({
                            ...item,
                            direction: 'downstream'
                        }));
                        downstreamCount = downData.total || 0;
                    }
                }

                // Combine results
                const allItems = [...upstreamItems, ...downstreamItems];
                const total = upstreamCount + downstreamCount;

                // Show results
                const resultsSection = document.getElementById('resultsSection');
                const resultsBody = document.getElementById('resultsBody');
                const emptyState = document.getElementById('emptyState');

                resultsSection.className = 'results-section visible';
                resultsBody.innerHTML = '';

                // Update stats
                document.getElementById('totalCount').textContent = total || 0;
                document.getElementById('dbCount').textContent = upstreamCount;
                document.getElementById('apiCount').textContent = downstreamCount;

                // Update stat labels for both mode
                if (direction === 'both') {
                    document.querySelectorAll('.stat-label')[1].textContent = 'Upstream';
                    document.querySelectorAll('.stat-label')[2].textContent = 'Downstream';
                } else {
                    document.querySelectorAll('.stat-label')[1].textContent = 'From Cache';
                    document.querySelectorAll('.stat-label')[2].textContent = 'From API';
                }

                // Update header
                const headerText = {
                    'both': 'Funding Relationships (Both Directions)',
                    'upstream': 'Funding Chain (Upstream)',
                    'downstream': 'Funded Addresses (Downstream)'
                };
                document.querySelector('.results-header h2').textContent = headerText[direction];

                if (allItems.length === 0) {
                    emptyState.style.display = 'block';
                    emptyState.querySelector('h3').textContent = 'No Funding Relationships Found';
                    emptyState.querySelector('p').textContent = 'No funding data found for this address.';
                    document.querySelector('.results-table-container').style.display = 'none';
                } else {
                    emptyState.style.display = 'none';
                    document.querySelector('.results-table-container').style.display = 'block';

                    allItems.forEach((item, index) => {
                        const row = document.createElement('tr');

                        const sourceClass = item.source === 'db_cache' ? 'db' : 'api';
                        const sourceLabel = item.source === 'db_cache' ? 'Cache' : 'API';

                        // Direction indicator
                        const dirClass = item.direction === 'upstream' ? 'color: var(--accent-purple);' : 'color: var(--accent-green);';
                        const dirLabel = item.direction === 'upstream' ? '↑ UP' : '↓ DOWN';

                        const levelHtml = item.level
                            ? `<span style="color: var(--accent-purple);">L${item.level}</span>`
                            : (item.is_confirmed_funding ? '<span class="confirmed-badge">Yes</span>' : '-');

                        const txSig = item.tx_signature || '';
                        const txHtml = txSig
                            ? `<a href="https://solscan.io/tx/${txSig}" target="_blank">${truncateAddress(txSig)}</a>`
                            : '-';

                        const amountHtml = item.amount_sol !== null && item.amount_sol !== undefined
                            ? item.amount_sol.toFixed(4)
                            : '-';

                        row.innerHTML = `
                            <td><span style="${dirClass} font-weight: 600; font-size: 10px;">${dirLabel}</span></td>
                            <td class="address-cell">
                                <a href="https://solscan.io/account/${item.address}" target="_blank">
                                    ${truncateAddress(item.address)}
                                </a>
                                <button class="copy-btn" onclick="copyToClipboard('${item.address}')" title="Copy address">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                    </svg>
                                </button>
                            </td>
                            <td class="amount-cell">${amountHtml}</td>
                            <td class="tx-link">${txHtml}</td>
                            <td><span class="source-badge ${sourceClass}">${sourceLabel}</span></td>
                            <td>${levelHtml}</td>
                        `;

                        resultsBody.appendChild(row);
                    });
                }

                const msg = direction === 'both'
                    ? `Found ${upstreamCount} upstream + ${downstreamCount} downstream`
                    : direction === 'upstream'
                        ? `Found ${total} level(s) in funding chain`
                        : `Found ${total} funded addresses`;
                showStatus(msg, 'success');
                setTimeout(hideStatus, 3000);

            } catch (error) {
                showStatus('Network error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Trace Funding';
            }
        }
    </script>
</body>
</html>
