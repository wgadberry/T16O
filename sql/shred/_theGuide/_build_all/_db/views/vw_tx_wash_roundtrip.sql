-- vw_tx_wash_roundtrip view
-- Generated from t16o_db instance

DROP VIEW IF EXISTS `vw_tx_wash_roundtrip`;

CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`%` SQL SECURITY DEFINER VIEW `vw_tx_wash_roundtrip` AS select `a1`.`address` AS `wallet_a`,`a2`.`address` AS `wallet_b`,`g1`.`id` AS `outbound_edge_id`,`g2`.`id` AS `return_edge_id`,`t1`.`signature` AS `outbound_tx`,`t2`.`signature` AS `return_tx`,`tk`.`token_symbol` AS `token_symbol`,(`g1`.`amount` / pow(10,`g1`.`decimals`)) AS `outbound_amount`,(`g2`.`amount` / pow(10,`g2`.`decimals`)) AS `return_amount`,`g1`.`block_time` AS `outbound_time`,`g2`.`block_time` AS `return_time`,(`g2`.`block_time` - `g1`.`block_time`) AS `seconds_between`,((abs((cast(`g1`.`amount` as signed) - cast(`g2`.`amount` as signed))) / `g1`.`amount`) * 100) AS `amount_diff_pct` from ((((((`tx_guide` `g1` join `tx_guide` `g2` on(((`g1`.`from_address_id` = `g2`.`to_address_id`) and (`g1`.`to_address_id` = `g2`.`from_address_id`) and (coalesce(`g1`.`token_id`,0) = coalesce(`g2`.`token_id`,0)) and (`g2`.`block_time` > `g1`.`block_time`) and (`g2`.`block_time` < (`g1`.`block_time` + 3600))))) join `tx_address` `a1` on((`g1`.`from_address_id` = `a1`.`id`))) join `tx_address` `a2` on((`g1`.`to_address_id` = `a2`.`id`))) join `tx` `t1` on((`g1`.`tx_id` = `t1`.`id`))) join `tx` `t2` on((`g2`.`tx_id` = `t2`.`id`))) left join `tx_token` `tk` on((`g1`.`token_id` = `tk`.`id`))) where (`g1`.`edge_type_id` in (select `tx_guide_type`.`id` from `tx_guide_type` where (`tx_guide_type`.`type_code` in ('spl_transfer','sol_transfer'))) and (`g1`.`amount` > 0));
