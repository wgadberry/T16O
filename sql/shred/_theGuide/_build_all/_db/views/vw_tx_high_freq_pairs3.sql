-- vw_tx_high_freq_pairs3 view
-- Generated from t16o_db instance

DROP VIEW IF EXISTS `vw_tx_high_freq_pairs3`;

CREATE ALGORITHM=UNDEFINED DEFINER=`root`@`%` SQL SECURITY DEFINER VIEW `vw_tx_high_freq_pairs3` AS with `transfer_edges` as (select `g`.`from_address_id` AS `from_address_id`,`g`.`to_address_id` AS `to_address_id`,`g`.`token_id` AS `token_id`,`g`.`amount` AS `amount`,`g`.`block_time` AS `block_time` from (`tx_guide` `g` join `tx_guide_type` `gt` on((`g`.`edge_type_id` = `gt`.`id`))) where `gt`.`type_code` member of ('["spl_transfer", "sol_transfer"]')) select least(`a1`.`address`,`a2`.`address`) AS `wallet_1`,greatest(`a1`.`address`,`a2`.`address`) AS `wallet_2`,`tk`.`token_symbol` AS `token_symbol`,`tk`.`decimals` AS `decimals`,count(0) AS `transfer_count`,sum((`te`.`from_address_id` = `a1`.`id`)) AS `wallet1_to_wallet2`,sum((`te`.`from_address_id` = `a2`.`id`)) AS `wallet2_to_wallet1`,(sum(`te`.`amount`) / pow(10,`tk`.`decimals`)) AS `total_volume`,min(`te`.`block_time`) AS `first_transfer`,max(`te`.`block_time`) AS `last_transfer`,timestampdiff(HOUR,min(`te`.`block_time`),max(`te`.`block_time`)) AS `hours_span`,(count(0) / greatest(timestampdiff(HOUR,min(`te`.`block_time`),max(`te`.`block_time`)),1)) AS `transfers_per_hour` from (((`transfer_edges` `te` join `tx_address` `a1` on((`te`.`from_address_id` = `a1`.`id`))) join `tx_address` `a2` on((`te`.`to_address_id` = `a2`.`id`))) left join `tx_token` `tk` on((`te`.`token_id` = `tk`.`id`))) where (`a1`.`id` <> `a2`.`id`) group by least(`a1`.`address`,`a2`.`address`),greatest(`a1`.`address`,`a2`.`address`),`tk`.`token_symbol`,`tk`.`decimals` having (count(0) >= 5);
