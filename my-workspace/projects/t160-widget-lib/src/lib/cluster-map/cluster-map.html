<div class="cluster-map-container">
  <p-card>
    <ng-template #header>
      <div class="card-header bubble-map-header">
        <h3><i class="pi pi-sitemap"></i> Cluster Map</h3>
        <div class="bubble-map-controls">
          <button pButton icon="pi pi-refresh" label="Reset Zoom" (click)="resetZoom()" class="p-button-text p-button-sm"></button>
          <button pButton icon="pi pi-tag" label="Toggle Labels" (click)="toggleLabels()" class="p-button-text p-button-sm"></button>
        </div>
      </div>
    </ng-template>

    <!-- Error Message -->
    <p-message *ngIf="errorMessage" severity="error" [text]="errorMessage" styleClass="w-full mb-3"></p-message>

    <!-- Loading -->
    <div *ngIf="loading" class="loading-container">
      <p-progressSpinner></p-progressSpinner>
      <span>Loading data...</span>
    </div>

    <!-- Bubble Map Container -->
    <div class="bubble-map-wrapper">
      <div #bubbleMapContainer class="bubble-map-canvas" [hidden]="loading"></div>

      <!-- Left Panels Container -->
      <div class="left-panels-container">
        <!-- Collapsible Query Panel -->
        <div class="query-panel" [class.collapsed]="!queryPanelExpanded">
          <button class="panel-toggle" (click)="toggleQueryPanel()">
            <i class="pi" [ngClass]="queryPanelExpanded ? 'pi-chevron-left' : 'pi-chevron-right'"></i>
            <span *ngIf="!queryPanelExpanded" class="toggle-label">Query</span>
          </button>
          <div class="panel-content" *ngIf="queryPanelExpanded">
            <div class="panel-header">
              <i class="pi pi-search"></i>
              <span>Query Token</span>
            </div>
            <div class="query-form">
              <div class="form-group">
                <label>Token Symbol</label>
                <input type="text" pInputText [(ngModel)]="tokenSymbol" placeholder="e.g. BONK">
              </div>
              <div class="form-group">
                <label>Mint Address</label>
                <input type="text" pInputText [(ngModel)]="mintAddress" placeholder="Mint address...">
              </div>
              <div class="form-group">
                <label>TX Window</label>
                <p-select [options]="txLimitOptions" [(ngModel)]="txLimit" optionLabel="label" optionValue="value" styleClass="w-full"></p-select>
              </div>
              <button pButton label="Load Token" icon="pi pi-play" (click)="loadData()" [loading]="loading" class="w-full"></button>
            </div>
          </div>
        </div>

        <!-- Collapsible Token Info Panel -->
        <div class="token-info-panel" *ngIf="currentData?.result?.token as token" [class.collapsed]="!tokenInfoPanelExpanded">
          <button class="panel-toggle" (click)="toggleTokenInfoPanel()">
            <i class="pi" [ngClass]="tokenInfoPanelExpanded ? 'pi-chevron-left' : 'pi-chevron-right'"></i>
            <span *ngIf="!tokenInfoPanelExpanded" class="toggle-label">{{ token.symbol || 'Token' }}</span>
          </button>
          <div class="panel-content" *ngIf="tokenInfoPanelExpanded">
            <div class="panel-header">
              <i class="pi pi-info-circle"></i>
              <span>Token Info</span>
            </div>
            <div class="token-symbol">{{ token.symbol || 'Unknown' }}</div>
            <div class="info-row">
              <span class="label">Mint</span>
              <div class="value-with-copy">
                <span class="value" [title]="token.mint || ''">{{ formatMintAddress(token.mint) }}</span>
                <button pButton icon="pi pi-copy" class="p-button-text p-button-sm copy-btn" (click)="copyToClipboard(token.mint)" pTooltip="Copy mint"></button>
              </div>
            </div>
            <div class="info-row">
              <span class="label">Nodes</span>
              <span class="value">{{ getNodesCount() }}</span>
            </div>
            <div class="info-row">
              <span class="label">Edges</span>
              <span class="value">{{ getEdgesCount() }}</span>
            </div>
          </div>
        </div>

        <!-- Transaction Navigation Panel -->
        <ng-container *ngIf="currentData?.result?.txs as txs">
          <div class="tx-nav-panel" [class.collapsed]="!txNavPanelExpanded">
            <button class="panel-toggle" (click)="toggleTxNavPanel()">
              <i class="pi" [ngClass]="txNavPanelExpanded ? 'pi-chevron-left' : 'pi-chevron-right'"></i>
              <span *ngIf="!txNavPanelExpanded" class="toggle-label">TX Nav</span>
            </button>
            <div class="panel-content" *ngIf="txNavPanelExpanded">
              <div class="panel-header">
                <i class="pi pi-bolt"></i>
                <span>Current TX</span>
              </div>
              <div class="tx-signature">{{ txs.signature }}</div>
              <div class="tx-time">{{ txs.block_time_utc }}</div>
              <div class="edge-types">
                <span *ngFor="let edgeType of txs.edge_types"
                      class="edge-type"
                      [ngClass]="edgeType">
                  {{ edgeType }}
                </span>
              </div>

              <div class="nav-section" *ngIf="txs.prev?.length">
                <h4>Previous ({{ getPrevCount() }})</h4>
                <div *ngFor="let tx of (txs.prev ?? []).slice(0, 3)"
                     class="nav-item"
                     (click)="navigateToTransaction(tx.signature)">
                  <div class="nav-sig">{{ tx.signature.slice(0, 16) }}...</div>
                  <div class="nav-time">{{ tx.block_time_utc }}</div>
                </div>
              </div>

              <div class="nav-section" *ngIf="txs.next?.length">
                <h4>Next ({{ getNextCount() }})</h4>
                <div *ngFor="let tx of (txs.next ?? []).slice(0, 3)"
                     class="nav-item"
                     (click)="navigateToTransaction(tx.signature)">
                  <div class="nav-sig">{{ tx.signature.slice(0, 16) }}...</div>
                  <div class="nav-time">{{ tx.block_time_utc }}</div>
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </div>

      <!-- Node Details Panel -->
      <div class="node-details-panel" *ngIf="selectedNode">
        <div class="details-header">
          <h4 [style.color]="selectedNode.color">{{ selectedNode.name }}</h4>
          <button pButton icon="pi pi-times" class="p-button-text p-button-rounded p-button-sm" (click)="closeDetailsPanel()"></button>
        </div>

        <div class="details-content">
          <div class="detail-row">
            <span class="detail-label">Type</span>
            <span class="detail-value type-badge" [style.background]="selectedNode.color + '33'" [style.color]="selectedNode.color">
              {{ selectedNode.label }}
            </span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Address</span>
            <div class="detail-value address-value">
              <span class="address-text" [title]="selectedNode.id">{{ selectedNode.id }}</span>
              <button pButton icon="pi pi-copy" class="p-button-text p-button-sm copy-btn" (click)="copyToClipboard(selectedNode.id)" pTooltip="Copy address"></button>
            </div>
          </div>

          <div class="detail-row">
            <span class="detail-label">Balance</span>
            <span class="detail-value balance-value">{{ selectedNode.balance | number:'1.0-2' }}</span>
          </div>

          <div class="detail-row" *ngIf="selectedNode.balanceUsd > 0">
            <span class="detail-label">USD Value</span>
            <span class="detail-value usd-value">{{ selectedNode.balanceUsd | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>

          <div class="detail-row">
            <span class="detail-label">Funded By</span>
            <div class="detail-value funded-by-list">
              <ng-container *ngIf="selectedNode.fundedBy.length > 0; else noFunder">
                <div *ngFor="let funder of selectedNode.fundedBy" class="funder-item">
                  <span class="funder-address">{{ funder.slice(0, 6) }}...{{ funder.slice(-4) }}</span>
                  <button pButton icon="pi pi-copy" class="p-button-text p-button-sm copy-btn" (click)="copyToClipboard(funder)" pTooltip="Copy address"></button>
                </div>
              </ng-container>
              <ng-template #noFunder>
                <span class="no-data">Under Investigation</span>
              </ng-template>
            </div>
          </div>

          <div class="connections-section">
            <h5>Connections</h5>
            <div class="connection-stats">
              <div class="stat-item incoming">
                <i class="pi pi-arrow-down"></i>
                <span>{{ getNodeConnections(selectedNode).incoming.length }} incoming</span>
              </div>
              <div class="stat-item outgoing">
                <i class="pi pi-arrow-up"></i>
                <span>{{ getNodeConnections(selectedNode).outgoing.length }} outgoing</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </p-card>
</div>
